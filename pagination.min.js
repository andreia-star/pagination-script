var postResults = typeof postPerPage !== "undefined" ? postPerPage : 7;
var currentPageNo = 1;
var postLabel = "";
var locationUrl = location.href;
var home_page = "/";

function startPagination(totalPosts) {
  var numOfPages = 5;
  var pageStart = 1;
  var lastPageNo = Math.ceil(totalPosts / postResults);
  var currentUrl = new URL(location.href);
  var startIndex = parseInt(currentUrl.searchParams.get("start-index")) || 1;
  currentPageNo = Math.floor((startIndex - 1) / postResults) + 1;

  var half = Math.floor(numOfPages / 2);
  pageStart = currentPageNo - half;
  if (pageStart < 1) pageStart = 1;
  var pageEnd = pageStart + numOfPages - 1;
  if (pageEnd > lastPageNo) pageEnd = lastPageNo;

  var output = '<span class="page-of">Página ' + currentPageNo + ' de ' + lastPageNo + '</span>';

  // Página anterior
  if (currentPageNo > 1) {
    output += '<a class="page-num page-prev" href="' + buildPageUrl(currentPageNo - 1) + '" aria-label="Página anterior" title="Página anterior">&laquo;</a>';
  }

  // Números
  for (var i = pageStart; i <= pageEnd; i++) {
    if (i === currentPageNo) {
      output += '<span class="page-num page-active">' + i + '</span>';
    } else {
      output += '<a class="page-num" href="' + buildPageUrl(i) + '">' + i + '</a>';
    }
  }

  // Próxima
  if (currentPageNo < lastPageNo) {
    output += '<a class="page-num page-next" href="' + buildPageUrl(currentPageNo + 1) + '" aria-label="Próxima página" title="Próxima página">&raquo;</a>';
  }

  document.querySelectorAll('[name="pageArea"]').forEach(el => el.innerHTML = output);
}

function buildPageUrl(pageNo) {
  var index = (pageNo - 1) * postResults + 1;
  var base = location.pathname.includes("/search/label/")
    ? location.pathname + '?start-index=' + index + '&max-results=' + postResults
    : '/search?start-index=' + index + '&max-results=' + postResults;
  return base;
}

function dataFeed(json) {
  var totalPosts = parseInt(json.feed.openSearch$totalResults.$t, 10);
  startPagination(totalPosts);
}

function pageCurrentBlogger() {
  if (location.href.indexOf(".html") === -1) {
    if (location.href.indexOf("/search/label/") !== -1) {
      postLabel = location.href.split("/search/label/")[1].split("?")[0];
      var s = document.createElement("script");
      s.src = home_page + "feeds/posts/summary/-/" + postLabel + "?alt=json-in-script&callback=dataFeed&max-results=0";
      document.head.appendChild(s);
    } else {
      var s = document.createElement("script");
      s.src = home_page + "feeds/posts/summary?alt=json-in-script&callback=dataFeed&max-results=0";
      document.head.appendChild(s);
    }
  }
}

pageCurrentBlogger();
