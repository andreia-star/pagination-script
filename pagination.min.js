(function(){
  const postPerPage = 6;
  let noPage = 1;
  let currentPageNo = 1;
  let currentPageType = "page";
  let label = "";
  const home = location.protocol + "//" + location.host + "/";

  function renderPagination(totalPosts) {
    const totalPages = Math.ceil(totalPosts / postPerPage);
    let html = "";
    const range = 3;
    const pageStart = Math.max(1, currentPageNo - range);
    const pageEnd = Math.min(totalPages, currentPageNo + range);

    if (currentPageNo > 1) {
      html += `<a class="page-prev" href="#" onclick="${currentPageType === 'label' ? 'goLabelPage' : 'goPage'}(${currentPageNo - 1});return false;">«</a>`;
    }

    for (let i = pageStart; i <= pageEnd; i++) {
      html += i === currentPageNo
        ? `<span class="page-active">${i}</span>`
        : `<a class="page-num" href="#" onclick="${currentPageType === 'label' ? 'goLabelPage' : 'goPage'}(${i});return false;">${i}</a>`;
    }

    if (currentPageNo < totalPages) {
      html += `<a class="page-next" href="#" onclick="${currentPageType === 'label' ? 'goLabelPage' : 'goPage'}(${currentPageNo + 1});return false;">»</a>`;
    }

    document.querySelectorAll('[name="pageArea"]').forEach(el => el.innerHTML = html);
  }

  function getTotalPosts(callback) {
    const url = currentPageType === "label"
      ? `${home}feeds/posts/summary/-/${label}?alt=json-in-script&max-results=0&callback=${callback}`
      : `${home}feeds/posts/summary?alt=json-in-script&max-results=0&callback=${callback}`;
    const s = document.createElement("script");
    s.src = url;
    document.head.appendChild(s);
  }

  function redirectToPage(json) {
    if (!json.feed.entry || json.feed.entry.length === 0) {
      document.querySelectorAll('[name="pageArea"]').forEach(el => el.innerHTML = "");
      return;
    }
    const published = json.feed.entry[0].published.$t;
    const encoded = encodeURIComponent(published.substring(0, 19) + published.substring(23));
    const target = currentPageType === "label"
      ? `/search/label/${label}?updated-max=${encoded}&max-results=${postPerPage}#PageNo=${noPage}`
      : `/search?updated-max=${encoded}&max-results=${postPerPage}#PageNo=${noPage}`;
    location.href = target.replace("?m=1", "").replace("&m=1", "");
  }

  function goPage(n) {
    noPage = n;
    const startIndex = (n - 1) * postPerPage;
    const s = document.createElement("script");
    s.src = `${home}feeds/posts/summary?start-index=${startIndex}&max-results=1&alt=json-in-script&callback=redirectToPage`;
    document.head.appendChild(s);
  }

  function goLabelPage(n) {
    noPage = n;
    const startIndex = (n - 1) * postPerPage;
    const s = document.createElement("script");
    s.src = `${home}feeds/posts/summary/-/${label}?start-index=${startIndex}&max-results=1&alt=json-in-script&callback=redirectToPage`;
    document.head.appendChild(s);
  }

  function initPagination() {
    const url = location.href;
    if (url.includes("/search/label/")) {
      currentPageType = "label";
      const parts = url.split("/search/label/")[1];
      label = decodeURIComponent(parts.split("?")[0]);
    }

    if (url.includes("#PageNo=")) {
      currentPageNo = parseInt(url.split("#PageNo=")[1]) || 1;
    }

    getTotalPosts("renderPagination");
  }

  window.renderPagination = renderPagination;
  window.redirectToPage = redirectToPage;
  document.addEventListener("DOMContentLoaded", initPagination);
})();
