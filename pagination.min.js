var postResults = typeof postPerPage !== "undefined" ? postPerPage : 7,
    numOfPages = 2,
    pageOf = ["Page", "of"],
    noPage, currentPage, currentPageNo, postLabel,
    locationUrl = location.href,
    home_page = "/";

function startPagination(totalPosts) {
  let html = "";
  let pageNumber = Math.floor(numOfPages / 2);
  numOfPages = pageNumber * 2 + 1;

  let pageStart = currentPageNo - pageNumber;
  if (pageStart < 1) pageStart = 1;

  let lastPageNo = Math.ceil(totalPosts / postResults);
  let pageEnd = pageStart + numOfPages - 1;
  if (pageEnd > lastPageNo) pageEnd = lastPageNo;

  html += '<span class="page-of">' + pageOf[0] + " " + currentPageNo + " " + pageOf[1] + " " + lastPageNo + "</span>";

  let prev = currentPageNo - 1;
  if (currentPageNo > 1) {
    html += currentPage === "page"
      ? (currentPageNo === 2
         ? `<a class="page-num page-prev" href="${home_page}"></a>`
         : `<a class="page-num page-prev" href="#" onclick="getPage(${prev});return false"></a>`)
      : `<a class="page-num page-prev" href="#" onclick="getLabelPage(${prev});return false"></a>`;
  }

  if (pageStart > 1) {
    html += currentPage === "page"
      ? `<a class="page-num" href="${home_page}">1</a>`
      : `<a class="page-num" href="/search/label/${postLabel}?&max-results=${postResults}">1</a>`;
  }

  if (pageStart > 2) {
    html += '<span class="page-num page-dots">...</span>';
  }

  for (let i = pageStart; i <= pageEnd; i++) {
    html += currentPageNo == i
      ? `<span class="page-num page-active">${i}</span>`
      : currentPage === "page"
        ? `<a class="page-num" href="#" onclick="getPage(${i});return false">${i}</a>`
        : `<a class="page-num" href="#" onclick="getLabelPage(${i});return false">${i}</a>`;
  }

  if (pageEnd < lastPageNo - 1) {
    html += '<span class="page-num page-dots">...</span>';
  }

  if (pageEnd < lastPageNo) {
    html += currentPage === "page"
      ? `<a class="page-num" href="#" onclick="getPage(${lastPageNo});return false">${lastPageNo}</a>`
      : `<a class="page-num" href="#" onclick="getLabelPage(${lastPageNo});return false">${lastPageNo}</a>`;
  }

  let next = currentPageNo + 1;
  if (currentPageNo < lastPageNo) {
    html += currentPage === "page"
      ? `<a class="page-num page-next" href="#" onclick="getPage(${next});return false"></a>`
      : `<a class="page-num page-next" href="#" onclick="getLabelPage(${next});return false"></a>`;
  }

  document.querySelectorAll('[name="pageArea"]').forEach(el => el.innerHTML = html);
  const pager = document.getElementById("blog-pager");
  if (pager) pager.innerHTML = html;
}

function dataFeed(json) {
  const totalPosts = parseInt(json.feed.openSearch$totalResults.$t, 10);
  startPagination(totalPosts);
}

function pageCurrentBlogger() {
  if (locationUrl.indexOf("/search/label/") !== -1) {
    postLabel = locationUrl.indexOf("?updated-max") !== -1
      ? locationUrl.substring(locationUrl.indexOf("/search/label/") + 14, locationUrl.indexOf("?updated-max"))
      : locationUrl.substring(locationUrl.indexOf("/search/label/") + 14, locationUrl.indexOf("?&max"));
  }

  if (locationUrl.indexOf("?q=") === -1 && locationUrl.indexOf(".html") === -1) {
    currentPage = locationUrl.indexOf("/search/label/") === -1 ? "page" : "label";
    currentPageNo = locationUrl.indexOf("#PageNo=") !== -1
      ? parseInt(locationUrl.split("#PageNo=")[1]) || 1
      : 1;

    const script = document.createElement("script");
    script.src = currentPage === "page"
      ? home_page + "feeds/posts/summary?max-results=1&alt=json-in-script&callback=dataFeed"
      : home_page + "feeds/posts/summary/-/" + postLabel + "?alt=json-in-script&callback=dataFeed&max-results=1";
    document.head.appendChild(script);
  }
}

function getPage(n) {
  noPage = n;
  const start = (n - 1) * postResults;
  const s = document.createElement("script");
  s.src = home_page + "feeds/posts/summary?start-index=" + start + "&max-results=1&alt=json-in-script&callback=findPostDate";
  document.head.appendChild(s);
}

function getLabelPage(n) {
  noPage = n;
  const start = (n - 1) * postResults;
  const s = document.createElement("script");
  s.src = home_page + "feeds/posts/summary/-/" + postLabel + "?start-index=" + start + "&max-results=1&alt=json-in-script&callback=findPostDate";
  document.head.appendChild(s);
}

function findPostDate(json) {
  if (!json.feed.entry || json.feed.entry.length === 0) return;

  const published = json.feed.entry[0].published.$t;
  const encodedDate = encodeURIComponent(published.substring(0, 19) + published.substring(23, 29));
  const url = currentPage === "page"
    ? `/search?updated-max=${encodedDate}&max-results=${postResults}#PageNo=${noPage}`
    : `/search/label/${postLabel}?updated-max=${encodedDate}&max-results=${postResults}#PageNo=${noPage}`;

  location.href = url.replace("?m=1", "").replace("&m=1", "");
}

pageCurrentBlogger();
