(function(){
  const postResults = 6;
  const totalPages = 5;
  let currentPage = 1;
  let currentType = "page";
  let label = "";
  let noPage = 1;
  const home = location.protocol + "//" + location.host + "/";

  function insertPagination(totalPosts) {
    const lastPage = Math.ceil(totalPosts / postResults);
    let start = Math.max(1, currentPage - Math.floor(totalPages / 2));
    let end = Math.min(lastPage, start + totalPages - 1);
    let html = "";

    if (currentPage > 1) {
      html += `<a class="page-prev" href="#" onclick="${currentType === 'label' ? 'getLabelPage' : 'getPage'}(${currentPage - 1});return false;">«</a>`;
    }

    for (let i = start; i <= end; i++) {
      if (i === currentPage) {
        html += `<span class="page-active">${i}</span>`;
      } else {
        html += `<a class="page-num" href="#" onclick="${currentType === 'label' ? 'getLabelPage' : 'getPage'}(${i});return false;">${i}</a>`;
      }
    }

    if (currentPage < lastPage) {
      html += `<a class="page-next" href="#" onclick="${currentType === 'label' ? 'getLabelPage' : 'getPage'}(${currentPage + 1});return false;">»</a>`;
    }

    document.querySelectorAll('[name="pageArea"]').forEach(el => el.innerHTML = html);
  }

  function getTotalPosts(callback) {
    const url = currentType === "label"
      ? `${home}feeds/posts/summary/-/${label}?alt=json-in-script&max-results=0&callback=${callback}`
      : `${home}feeds/posts/summary?alt=json-in-script&max-results=0&callback=${callback}`;
    const s = document.createElement("script");
    s.src = url;
    document.head.appendChild(s);
  }

  function loadRedirect(json) {
    if (!json.feed.entry) return;
    const entry = json.feed.entry[0];
    const date = encodeURIComponent(entry.published.$t.substring(0, 19) + entry.published.$t.substring(23));
    const url = currentType === "label"
      ? `/search/label/${label}?updated-max=${date}&max-results=${postResults}#PageNo=${noPage}`
      : `/search?updated-max=${date}&max-results=${postResults}#PageNo=${noPage}`;
    location.href = url.replace("?m=1", "").replace("&m=1", "");
  }

  function getPage(pageNum) {
    noPage = pageNum;
    const start = (pageNum - 1) * postResults;
    const s = document.createElement("script");
    s.src = `${home}feeds/posts/summary?start-index=${start}&max-results=1&alt=json-in-script&callback=loadRedirect`;
    document.head.appendChild(s);
  }

  function getLabelPage(pageNum) {
    noPage = pageNum;
    const start = (pageNum - 1) * postResults;
    const s = document.createElement("script");
    s.src = `${home}feeds/posts/summary/-/${label}?start-index=${start}&max-results=1&alt=json-in-script&callback=loadRedirect`;
    document.head.appendChild(s);
  }

  function initPagination() {
    const url = location.href;
    if (url.includes("/search/label/")) {
      currentType = "label";
      label = decodeURIComponent(url.split("/search/label/")[1].split("?")[0]);
    }

    if (url.includes("#PageNo=")) {
      currentPage = parseInt(url.split("#PageNo=")[1]) || 1;
    }

    getTotalPosts("insertPagination");
  }

  window.insertPagination = insertPagination;
  window.loadRedirect = loadRedirect;

  document.addEventListener("DOMContentLoaded", initPagination);
})();
